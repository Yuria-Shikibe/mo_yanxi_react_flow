name: Xmake Build

env:
  TARGET_NAME: mo_yanxi.react_flow
  LLVM_VER: 21

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [
          windows-latest,
          ubuntu-latest
        ]
        toolchain: [ msvc, clang, gcc ]
        mode: [ debug, release ]
        include:
          - os: windows-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: clang

          # 2. Linux: 使用 GCC/Clang
#          - os: ubuntu-latest
#            toolchain: gcc
          - os: ubuntu-latest
            toolchain: clang

        exclude:
          - os: ubuntu-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: gcc
    #          - os: ubuntu-latest
    #            toolchain: msvc
          - os: ubuntu-latest
            toolchain: gcc


    steps:
      - uses: actions/checkout@v4

      # 1. 设置 xmake 环境 (使用最新版)
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
      #          actions-cache-folder: '.xmake-cache'


      - name: Install LLVM  (Linux Clang only)
        if: matrix.os == 'ubuntu-latest' && matrix.toolchain == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VER }} all
          sudo apt-get install -y libc++-${{ env.LLVM_VER }}-dev libc++abi-${{ env.LLVM_VER }}-dev clang-tools-${{ env.LLVM_VER }} libunwind-${{ env.LLVM_VER }}-dev
          echo "/usr/lib/llvm-${{ env.LLVM_VER }}/bin" >> $GITHUB_PATH

      - name: Build ${{ matrix.mode }}
        shell: bash
        run: |
          # 基础标志定义为数组
          XMAKE_FLAGS=(-m ${{ matrix.mode }} --toolchain=${{ matrix.toolchain }} -yv)
          EXTRA_FLAGS=()

          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
             PLAT_FLAGS="-p linux"
          else
             PLAT_FLAGS="-p windows"
          fi

          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.toolchain }}" == "clang" ]]; then
             clang --version
             # 修改点：去掉 ldflags 值周围的单引号
             # Bash 数组配合 "${EXTRA_FLAGS[@]}" 已经足以保证这串带有空格的参数作为一个整体传递给 xmake
             EXTRA_FLAGS=(
               "--sdk=/usr/lib/llvm-${{ env.LLVM_VER }}"
               "--cxflags=-stdlib=libc++"
               "--ldflags=-stdlib=libc++ -lc++abi -lunwind"
             )
          fi

          echo "Configuring with: ${XMAKE_FLAGS[@]} $PLAT_FLAGS ${EXTRA_FLAGS[@]}"

          # 强制清理配置并传递数组参数
          # 注意："${EXTRA_FLAGS[@]}" 必须加引号，这样 Bash 才会把 "--ldflags=... ... ..." 当作单独的一个参数传给 xmake
          xmake f -c $PLAT_FLAGS "${XMAKE_FLAGS[@]}" "${EXTRA_FLAGS[@]}"

          xmake -bvy ${{ env.TARGET_NAME }}.test

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.toolchain }}-${{ matrix.mode }}
          path: build

  test:
    needs: build
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [
          windows-latest,
          ubuntu-latest
        ]
        toolchain: [ msvc, clang, gcc ]
        mode: [ debug, release ]
        include:
          - os: windows-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: clang

          # 2. Linux: 使用 GCC/Clang
#          - os: ubuntu-latest
#            toolchain: gcc
          - os: ubuntu-latest
            toolchain: clang

        exclude:
          - os: ubuntu-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: gcc
    #          - os: ubuntu-latest
    #            toolchain: msvc
          - os: ubuntu-latest
            toolchain: gcc

    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM  (Linux Clang only)
        if: matrix.os == 'ubuntu-latest' && matrix.toolchain == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VER }} all
          sudo apt-get install -y libc++-${{ env.LLVM_VER }}-dev libc++abi-${{ env.LLVM_VER }}-dev clang-tools-${{ env.LLVM_VER }} libunwind-${{ env.LLVM_VER }}-dev
          echo "/usr/lib/llvm-${{ env.LLVM_VER }}/bin" >> $GITHUB_PATH

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.toolchain }}-${{ matrix.mode }}
          path: build

      - name: Run Test
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            ./build/windows/x64/${{ matrix.mode }}/${{ env.TARGET_NAME }}.test.exe
          else
            chmod +x ./build/linux/x64/${{ matrix.mode }}/${{ env.TARGET_NAME }}.test
            ./build/linux/x64/${{ matrix.mode }}/${{ env.TARGET_NAME }}.test
          fi
